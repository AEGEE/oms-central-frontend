<!DOCTYPE html>
<!--[if IE 8]> <html lang="en" class="ie8"> <![endif]-->
<!--[if !IE]><!-->
<html lang="en" ng-app="omsApp">
<!--<![endif]-->
<head>
  <base href="/">
  <meta charset="utf-8" />
  <title data-ng-bind="'{{appName}} | ' + $state.current.data.pageTitle">{{appName}}</title>
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport" />
  {{#each metaTags}}
  <meta content="{{this.content}}" name="{{this.name}}" />
  {{/each}}
  
  <!-- ================== Vendor CSS ================== -->
  {{#each externalCSS}}
  <link href="{{this}}" rel="stylesheet" />
  {{/each}}
  <link href="assets/vendor.css" rel="stylesheet" />

  <!-- ================== Main app style ================== --> 
  <link href="assets/main.css" rel="stylesheet" />

  <!-- ================== Microservice includes ================== -->
  {{#each internalCSS}}
  <link href="{{this}}" rel="stylesheet" />
  {{/each}}

  {{#if debugBuild}}
  <!-- ================== Debug build warning sign ================== -->
  <style type="text/css">
    #devMode {
      display: block;
      /*position: absolute;*/
      height: 60px;
      /*width: 400px;*/
      background-color: #E91E63;
      z-index: 99998;
      box-shadow: 0 1px 5px 0 rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 3px 1px -2px rgba(0,0,0,.12);
      color: #fff;
      top: 90%;
      right: 0.5%;
    }

    #devMessage {
      padding: 8px;
      font-size: 16px;
    }
  </style>
  {{/if}}
</head>
<body ng-controller="appController" ng-class="{'pace-top': setting.layout.paceTop, 'boxed-layout': setting.layout.pageBoxedLayout, 'bg-white': setting.layout.pageBgWhite }">
  <!-- begin #page-loader -->
  <!--<div id="page-loader" ng-controller="pageLoaderController" class="fade in"><span class="spinner"></span></div>-->
  <!-- end #page-loader -->
  
  <!-- begin #page-container -->
  <div id="page-container" class="page-container page-sidebar-fixed page-header-fixed fade"
  ng-class="{
    'page-sidebar-minified': setting.layout.pageSidebarMinified,
    'page-content-full-height': setting.layout.pageContentFullHeight,
    'page-footer-fixed': setting.layout.pageFixedFooter,
    'page-with-right-sidebar': setting.layout.pageRightSidebar,
    'page-sidebar-minified': setting.layout.pageSidebarMinified,
    'page-with-two-sidebar': setting.layout.pageTwoSidebar,
    'page-right-sidebar-toggled': setting.layout.pageTwoSidebar,
    'page-with-top-menu': setting.layout.pageTopMenu,
    'page-without-sidebar': setting.layout.pageWithoutSidebar,
    'page-with-wide-sidebar': setting.layout.pageWideSidebar,
    'page-with-light-sidebar': setting.layout.pageLightSidebar,
    'p-t-0': setting.layout.pageWithoutHeader
  }">
    <div id="loadingOverlay" class="hiddenItem">
      <div class="loadingText">
        <img src="assets/img/loading.gif" /> Loading, please wait!
      </div>
    </div>
    <div id="main" ui-view="main"></div>
  </div>
  <!-- end page container -->
  {{#if debugBuild}}
  <div id="devMode">
    <div id="devMessage" class="text-center">
      <b>** DEBUG BUILD **</b> <br />All data is volatile and can be reverted at any time!
    </div>
  </div>
  {{/if}}

  <!-- ================== Vendor js ================== -->

  {{#each externalJS}}
  <script type="text/javascript" src="{{this}}"></script>
  {{/each}}
  <script type="text/javascript" src="assets/vendor.js"></script>

  <!-- ================== Base js ================== -->
  <script type="text/javascript">
    /**
     * Main module
     */

    var omsApp = angular
    .module('omsApp', [
      {{#each angularModules}}
      '{{this}}',
      {{/each}}
    ])
    .config(appConfig)
    .factory(responseObserver)
    .run(appRun);


    var baseUrlRepository = {
      {{#each baseUrlRepo}}
        "{{this.code}}": "{{this.url}}",
      {{/each}}
    };

    // TODO get this part out of the index.html somehow
    function appConfig($stateProvider, $urlRouterProvider, $locationProvider, $httpProvider)
    {
      $httpProvider.interceptors.push(responseObserver);
      $locationProvider.html5Mode(true);

      $urlRouterProvider.otherwise('/');

      $stateProvider.state('app', {
        abstract: true,
        views: {
          'main@': {
            templateUrl: 'partials/loggedInTemplate.html'
          },
          'header@app': {
            templateUrl: 'partials/header.html',
            controller: "headerController as vm"
          },
          'sidebar@app': {
            templateUrl: 'partials/sidebar.html'
          }

        },
        data: {
          requireLogin: true
        }
      })
      .state('public', {
        abstract: true,
        data: {
          requireLogin: false
        }
      });
    }

    /** @ngInject */
    function appRun($rootScope, $state, setting, $http, loginModal) {
      $rootScope.$state = $state;
      $rootScope.setting = setting;
      $rootScope.currentUser = undefined;

      $rootScope.$on('$stateChangeStart', function (event, toState, toParams) {
        var requireLogin = toState.data.requireLogin;

        // On a route which requires login, check if we know user data
        if (requireLogin && typeof $rootScope.currentUser === 'undefined') {
          event.preventDefault();

          // If we still have a token, try if it's valid to fetch the user data
          var token = window.localStorage.getItem("X-Auth-Token");
          if(token) {
            // We still have a token, attemp to fetch data
            $http({
              method: 'POST',
              url: '/api/tokens/user',
              data: {
                token: token
              },
              headers: {
                "X-Auth-Token": token
              }
            }).then((response) => {
              // Worked, we are still logged in from the last time

              $http.defaults.headers.common['X-Auth-Token'] = token;
              $.ajaxSetup({headers: { 'X-Auth-Token': token }});
              $rootScope.currentUser = response.data.data;
              $state.go(toState.name, toParams)
            }).catch((err) => {
              // Errors were intercepted by the response observer already, we can just check if the login was successful
              if($rootScope.currentUser)
                return $state.go(toState.name, toParams);
              else
                return $state.go('public.welcome');
            });
          } else {
            // Otherwise we will have to log in anyways
            loginModal()
            .then(function () {
              // Successful login
              return $state.go(toState.name, toParams);
            })
            .catch(function () {
              // Unsuccessful login
              return $state.go('public.welcome');
            });
          }
        }
      });
    }


    /** @ngInject */
    function responseObserver($q, $window, $timeout, $injector) {
      var loginModal, $http, $state;

      // this trick must be done so that we don't receive
      // `Uncaught Error: [$injector:cdep] Circular dependency found`
      $timeout(function () {
        loginModal = $injector.get('loginModal');
        $http = $injector.get('$http');
        $state = $injector.get('$state');
      });

      return {
        'responseError': function(errorResponse) {
          $('#loadingOverlay').hide();
          switch (errorResponse.status) {
            case 401: // Trust the backend to only send this upon invalid access token
              var deferred = $q.defer();

              loginModal()
              .then(function () {
                // The old X-Auth-Token is still stored in the requests and they would fail again, thus replace
                errorResponse.config.headers['X-Auth-Token'] = window.localStorage.getItem("X-Auth-Token")
                deferred.resolve( $http(errorResponse.config) );
              })
              .catch(function () {
                $state.go('public.welcome');
                deferred.reject(errorResponse);
              });
            return deferred.promise;
            case 403:
              $.gritter.add({
                title: 'Permission error!',
                text: "Not enough permissions!",
                sticky: false,
                time: 8000,
                class_name: 'my-sticky-class'
              });
            break;
            case 500:
              $.gritter.add({
                title: 'Error!',
                text: "Please try again later",
                sticky: false,
                time: 8000,
                class_name: 'testClass'
              });
            break;
          }
          return $q.reject(errorResponse);
        }
      };
    }

   
  </script>
  
  <script type="text/javascript" src="assets/main.js"></script>

  <!-- ================== Microservice includes  ================== -->
  {{#each internalJS}}
  <script type="text/javascript" src="{{this}}"></script>
  {{/each}}
</body>
</html>
